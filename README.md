# vite-plugin-dev-link

ä¸€ä¸ª Vite æ’ä»¶ï¼Œç”¨äºåœ¨å¼€å‘è¿‡ç¨‹ä¸­å°†æœ¬åœ°åŒ…é“¾æ¥åˆ°é¡¹ç›®ä¸­ï¼Œæ›¿ä»£ node_modules ä¸­çš„å¯¹åº”åŒ…ã€‚æ”¯æŒçƒ­æ¨¡å—æ›¿æ¢(HMR)ã€è‡ªåŠ¨åŒ…æ‰«æã€æ™ºèƒ½è·¯å¾„è§£æç­‰åŠŸèƒ½ï¼Œè®©æœ¬åœ°åŒ…å¼€å‘ä½“éªŒå¦‚ä¸èˆ¬é¡ºæ»‘ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

-   ğŸ”— **æœ¬åœ°åŒ…é“¾æ¥**: å°†æœ¬åœ°å¼€å‘çš„åŒ…é“¾æ¥åˆ°é¡¹ç›®ä¸­ï¼Œæ›¿ä»£ node_modules ä¸­çš„åŒ…
-   ğŸ”¥ **çƒ­æ¨¡å—æ›¿æ¢(HMR)**: æ”¯æŒæœ¬åœ°åŒ…æ–‡ä»¶å˜åŒ–æ—¶çš„çƒ­æ›´æ–°ï¼Œæ— éœ€æ•´é¡µåˆ·æ–°
-   ğŸ” **è‡ªåŠ¨åŒ…æ‰«æ**: è‡ªåŠ¨æ‰«ææœ¬åœ°ç›®å½•ï¼Œå‘ç°æ‰€æœ‰å¯ç”¨çš„åŒ…ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
-   ğŸ“ **æ™ºèƒ½è·¯å¾„è§£æ**: ç›¸å¯¹è·¯å¾„ç›¸å¯¹äºé…ç½®æ–‡ä»¶ç›®å½•è§£æï¼Œæ”¯æŒå¤šç§è·¯å¾„é…ç½®æ–¹å¼
-   ğŸ¯ **ç²¾ç¡®æ§åˆ¶**: å¯ä»¥æŒ‡å®šå…¥å£æ–‡ä»¶ã€æ’é™¤æ–‡ä»¶ï¼Œæ”¯æŒå¤šåŒ…é…ç½®
-   ğŸ“ **æ¸…æ™°æ—¥å¿—**: æä¾›è¯¦ç»†ä¸”æ¸…æ™°çš„è°ƒè¯•æ—¥å¿—ï¼Œå¿«é€Ÿå®šä½åŒ…é…ç½®é—®é¢˜
-   ğŸ›¡ï¸ **å®‰å…¨å¯ç”¨**: é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼Œé¿å…æ„å¤–å¯ç”¨å½±å“æ­£å¸¸å¼€å‘
-   ğŸ”§ **çµæ´»é…ç½®**: æ”¯æŒå…¨å±€é…ç½®å’Œå•åŒ…é…ç½®çš„çµæ´»ç»„åˆ

## ğŸ“¦ å®‰è£…

```bash
npm install vite-plugin-dev-link --save-dev
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ğŸ¯ ç®€åŒ–é…ç½®ï¼ˆæ¨èï¼‰

**ä¸€è¡Œé…ç½®ï¼Œå¼€ç®±å³ç”¨ï¼š**

```typescript
import { defineConfig } from "vite";
import vitePluginDevLink from "vite-plugin-dev-link";

export default defineConfig({
    plugins: [
        vitePluginDevLink({ preset: "local-dev" }), // ğŸ¯ é›¶é…ç½®ï¼Œè‡ªåŠ¨æ‰«æ ../local-packages
    ],
});
```

```bash
npm run dev  # æ— éœ€ç¯å¢ƒå˜é‡ï¼Œç›´æ¥å¯åŠ¨
```

**âœ¨ ç®€åŒ–æ•ˆæœå¯¹æ¯”ï¼š**

| æ–¹æ¡ˆ        | é…ç½®æ–‡ä»¶ | é…ç½®è¡Œæ•° | ç¯å¢ƒå˜é‡ | å­¦ä¹ æˆæœ¬ |
| ----------- | -------- | -------- | -------- | -------- |
| ğŸ¯ ç®€åŒ–é…ç½® | 1 ä¸ª     | 1 è¡Œ     | ä¸éœ€è¦   | ä½       |
| ä¼ ç»Ÿé…ç½®    | 2 ä¸ª     | 20+ è¡Œ   | éœ€è¦     | é«˜       |

### ğŸ“‹ å…¶ä»–ç®€åŒ–æ–¹å¼

```typescript
// è‡ªå®šä¹‰æ‰«æç›®å½•
vitePluginDevLink({ autoLink: "../packages" });

// ç²¾ç¡®æŒ‡å®šåŒ…æ˜ å°„
vitePluginDevLink({
    packages: {
        "@my/ui": "../ui-lib",
        "@my/utils": "../utils-lib",
    },
});
```

### ğŸ”§ ä¼ ç»Ÿé…ç½®æ–¹å¼

å¦‚éœ€æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œä»å¯ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼š

```typescript
export default defineConfig({
    plugins: [
        vitePluginDevLink({
            configFile: "dev-link.json", // é…ç½®æ–‡ä»¶è·¯å¾„
            enabled: true, // æ˜¯å¦å¯ç”¨æ’ä»¶
            verbose: true, // æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
        }),
    ],
});
```

### 2. åˆ›å»ºé…ç½®æ–‡ä»¶

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `dev-link.json` é…ç½®æ–‡ä»¶ï¼š

```json
{
    "globalLocalPath": "../local-packages",
    "autoScan": true,
    "links": [
        {
            "package": ["@my-org/ui-components", "@my-org/icons"],
            "entryFile": "index.js"
        }
    ],
    "globalExclude": [
        "**/*.test.js",
        "**/*.test.ts",
        "**/*.spec.js",
        "**/*.spec.ts",
        "**/node_modules/**",
        "**/.git/**"
    ]
}
```

### 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

ä½¿ç”¨ç¯å¢ƒå˜é‡å¯ç”¨ dev-link åŠŸèƒ½ï¼š

```bash
DEV_LINK=true npm run dev
```

## âš™ï¸ é…ç½®é€‰é¡¹

### æ’ä»¶é€‰é¡¹

#### ğŸ¯ ç®€åŒ–é…ç½®é€‰é¡¹

| é€‰é¡¹       | ç±»å‹                                           | é»˜è®¤å€¼ | æè¿°                         |
| ---------- | ---------------------------------------------- | ------ | ---------------------------- |
| `preset`   | `'monorepo' \| 'local-dev' \| 'component-lib'` | -      | é¢„è®¾æ¨¡å¼ï¼Œé›¶é…ç½®å¿«é€Ÿå¯åŠ¨     |
| `autoLink` | `string \| string[]`                           | -      | è‡ªåŠ¨æ‰«ææŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰åŒ…   |
| `packages` | `Record<string, string>`                       | -      | ç›´æ¥æŒ‡å®šåŒ…ååˆ°æœ¬åœ°è·¯å¾„çš„æ˜ å°„ |

#### ğŸ”§ é€šç”¨é€‰é¡¹

| é€‰é¡¹         | ç±»å‹      | é»˜è®¤å€¼            | æè¿°             |
| ------------ | --------- | ----------------- | ---------------- |
| `configFile` | `string`  | `'dev-link.json'` | é…ç½®æ–‡ä»¶è·¯å¾„     |
| `enabled`    | `boolean` | `true`            | æ˜¯å¦å¯ç”¨æ’ä»¶     |
| `verbose`    | `boolean` | `false`           | æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ—¥å¿— |

#### ğŸ¯ é¢„è®¾è¯´æ˜

| é¢„è®¾              | æ‰«æç›®å½•            | é€‚ç”¨åœºæ™¯      |
| ----------------- | ------------------- | ------------- |
| `'monorepo'`      | `../packages`       | Monorepo é¡¹ç›® |
| `'local-dev'`     | `../local-packages` | æœ¬åœ°å¼€å‘åŒ…    |
| `'component-lib'` | `../components`     | ç»„ä»¶åº“å¼€å‘    |

### é…ç½®æ–‡ä»¶æ ¼å¼

#### DevLinkConfigFile

| å­—æ®µ              | ç±»å‹            | å¿…å¡« | æè¿°                                         |
| ----------------- | --------------- | ---- | -------------------------------------------- |
| `globalLocalPath` | `string`        | âŒ   | å…¨å±€æœ¬åœ°åŒ…è·¯å¾„ï¼Œä½œä¸ºé»˜è®¤è·¯å¾„                 |
| `links`           | `LinkMapping[]` | âœ…   | é“¾æ¥é…ç½®æ•°ç»„                                 |
| `globalExclude`   | `string[]`      | âŒ   | å…¨å±€æ’é™¤æ¨¡å¼                                 |
| `autoScan`        | `boolean`       | âŒ   | æ˜¯å¦è‡ªåŠ¨æ‰«ææœ¬åœ°ç›®å½•ä¸‹çš„ package.json        |
| `globalEntryFile` | `string`        | âŒ   | å…¨å±€é»˜è®¤å…¥å£æ–‡ä»¶ï¼ˆç›¸å¯¹äºå¯¹åº”åŒ…çš„ localPathï¼‰ |

#### LinkMapping

| å­—æ®µ        | ç±»å‹                 | å¿…å¡« | æè¿°                                     |
| ----------- | -------------------- | ---- | ---------------------------------------- |
| `package`   | `string \| string[]` | âœ…   | åŒ…åæˆ–åŒ…åæ•°ç»„                           |
| `localPath` | `string`             | âŒ   | æœ¬åœ°æºç è·¯å¾„ï¼ˆå¦‚æœæœªæŒ‡å®šåˆ™ä½¿ç”¨å…¨å±€è·¯å¾„ï¼‰ |
| `entryFile` | `string`             | âŒ   | æŒ‡å®šåŒ…çš„å…¥å£æ–‡ä»¶ï¼ˆç›¸å¯¹äº localPathï¼‰     |
| `exclude`   | `string[]`           | âŒ   | æ’é™¤çš„æ–‡ä»¶æ¨¡å¼                           |

## ğŸ”§ é«˜çº§åŠŸèƒ½

### è‡ªåŠ¨åŒ…æ‰«æ (autoScan)

å¯ç”¨ `autoScan: true` åï¼Œæ’ä»¶ä¼šè‡ªåŠ¨æ‰«æ `globalLocalPath` ç›®å½•ä¸‹çš„æ‰€æœ‰åŒ…ï¼š

```json
{
    "globalLocalPath": "../local-packages",
    "autoScan": true,
    "links": [
        {
            "package": ["@test/ui-components", "@test/icons"]
            // ä¸éœ€è¦é…ç½® localPathï¼Œä¼šè‡ªåŠ¨å‘ç°
        }
    ]
}
```

æ‰«æè§„åˆ™ï¼š

-   æ”¯æŒæ™®é€šåŒ…ï¼š`package-name/package.json`
-   æ”¯æŒä½œç”¨åŸŸåŒ…ï¼š`@scope/package-name/package.json`
-   é€šè¿‡è¯»å– `package.json` ä¸­çš„ `name` å­—æ®µè·å–åŒ…å

### è·¯å¾„è§£æä¼˜å…ˆçº§

1. **åŒ…é…ç½®çš„ localPath**: å¦‚æœåœ¨ `links` ä¸­æŒ‡å®šäº† `localPath`
2. **è‡ªåŠ¨æ‰«æç»“æœ**: å¦‚æœå¯ç”¨äº† `autoScan` ä¸”æ‰¾åˆ°äº†åŒ…
3. **å…¨å±€è·¯å¾„**: ä½¿ç”¨ `globalLocalPath` ä½œä¸ºåå¤‡

### å…¥å£æ–‡ä»¶è§£æ

æ”¯æŒå¤šç§å…¥å£æ–‡ä»¶é…ç½®æ–¹å¼ï¼š

1. **åŒ…çº§ entryFile**: åœ¨ `links` ä¸­ä¸ºç‰¹å®šåŒ…é…ç½®
2. **å…¨å±€ entryFile**: åœ¨æ ¹é…ç½®ä¸­é…ç½® `globalEntryFile`
3. **è‡ªåŠ¨æŸ¥æ‰¾**: æŒ‰é¡ºåºæŸ¥æ‰¾ `index.ts` â†’ `index.js` â†’ `package.json`

### çƒ­æ¨¡å—æ›¿æ¢ (HMR)

æ’ä»¶å†…ç½®äº†æ™ºèƒ½çš„ HMR æ”¯æŒï¼š

-   ğŸ“ **æ–‡ä»¶æ˜ å°„**: è‡ªåŠ¨å»ºç«‹æ–‡ä»¶è·¯å¾„åˆ°æ¨¡å— ID çš„æ˜ å°„
-   ğŸ”¥ **ç²¾å‡†æ›´æ–°**: åªæ›´æ–°å˜åŒ–çš„æ¨¡å—ï¼Œä¸ä¼šæ•´é¡µåˆ·æ–°
-   ğŸ”„ **å¤šçº§å›é€€**: æ™ºèƒ½æŸ¥æ‰¾éœ€è¦æ›´æ–°çš„æ¨¡å—
-   ğŸ“ **è¯¦ç»†æ—¥å¿—**: æ˜¾ç¤º HMR æ›´æ–°è¿‡ç¨‹

## ğŸ“– ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: ç»„ä»¶åº“å¼€å‘

å¼€å‘ç»„ä»¶åº“æ—¶åœ¨å¦ä¸€ä¸ªé¡¹ç›®ä¸­å®æ—¶æµ‹è¯•ï¼š

```json
{
    "globalLocalPath": "../my-ui-lib",
    "autoScan": true,
    "links": [
        {
            "package": "@company/ui-kit",
            "entryFile": "dist/index.js",
            "exclude": ["**/*.test.*", "**/*.stories.*"]
        }
    ]
}
```

### åœºæ™¯ 2: å¤šåŒ…å·¥ä½œåŒº

åŒæ—¶å¼€å‘å¤šä¸ªç›¸å…³åŒ…ï¼š

```json
{
    "globalLocalPath": "../packages",
    "autoScan": true,
    "globalEntryFile": "src/index.ts",
    "links": [
        {
            "package": [
                "@company/core",
                "@company/utils",
                "@company/components"
            ]
        }
    ]
}
```

### åœºæ™¯ 3: æ··åˆé…ç½®

éƒ¨åˆ†åŒ…ä½¿ç”¨è‡ªåŠ¨æ‰«æï¼Œéƒ¨åˆ†åŒ…æ‰‹åŠ¨é…ç½®ï¼š

```json
{
    "globalLocalPath": "../packages",
    "autoScan": true,
    "links": [
        {
            "package": ["@company/ui", "@company/icons"]
            // ä½¿ç”¨è‡ªåŠ¨æ‰«æ
        },
        {
            "package": "legacy-package",
            "localPath": "../legacy/src",
            "entryFile": "main.js"
            // æ‰‹åŠ¨é…ç½®
        }
    ]
}
```

## ğŸ” å·¥ä½œåŸç†

1. **ç¯å¢ƒæ£€æµ‹**: æ£€æŸ¥ `DEV_LINK` ç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½®ä¸º `true`
2. **é…ç½®åŠ è½½**: è¯»å–é…ç½®æ–‡ä»¶ï¼Œç›¸å¯¹è·¯å¾„ç›¸å¯¹äºé…ç½®æ–‡ä»¶ç›®å½•è§£æ
3. **åŒ…æ‰«æ**: å¦‚æœå¯ç”¨äº† `autoScan`ï¼Œæ‰«æå¹¶å‘ç°æœ¬åœ°åŒ…
4. **æ¨¡å—è§£æ**: æ‹¦æˆªæ¨¡å—å¯¼å…¥è¯·æ±‚ï¼Œæ£€æŸ¥æ˜¯å¦åŒ¹é…é…ç½®çš„åŒ…å
5. **è·¯å¾„é‡å†™**: å°†åŒ¹é…çš„åŒ…å¯¼å…¥é‡å®šå‘åˆ°æœ¬åœ°æ–‡ä»¶è·¯å¾„
6. **æ–‡ä»¶ç›‘å¬**: ç›‘å¬æœ¬åœ°æ–‡ä»¶å˜åŒ–ï¼Œå»ºç«‹æ–‡ä»¶åˆ°æ¨¡å—çš„æ˜ å°„
7. **HMR å¤„ç†**: æ–‡ä»¶å˜åŒ–æ—¶è§¦å‘ç²¾å‡†çš„çƒ­æ¨¡å—æ›¿æ¢

## ğŸ“ æ—¥å¿—è¯´æ˜

æ’ä»¶æä¾›æ¸…æ™°çš„æ—¥å¿—ä¿¡æ¯ï¼š

```bash
# å¯åŠ¨æ—¶
ğŸ”— [vite-plugin-dev-link] å·²åŠ è½½é…ç½®æ–‡ä»¶: /path/to/dev-link.json
ğŸ”— [vite-plugin-dev-link] è‡ªåŠ¨æ‰«ææœ¬åœ°åŒ…: ../local-packages
ğŸ”— [vite-plugin-dev-link] å‘ç°æœ¬åœ°åŒ…: @test/ui-components -> local-packages/@test/ui-components
ğŸ”— [vite-plugin-dev-link] æˆåŠŸé“¾æ¥åŒ…: @test/ui-components -> local-packages/@test/ui-components

# æ¨¡å—è§£ææ—¶
ğŸ”— [vite-plugin-dev-link] è§£æ @test/ui-components -> local-packages/@test/ui-components/index.js (ä½¿ç”¨é…ç½®çš„ entryFile)

# HMRæ›´æ–°æ—¶
ğŸ”— [vite-plugin-dev-link] ğŸ”¥ HMRæ›´æ–°: local-packages/@test/ui-components/index.js -> @test/ui-components

# é”™è¯¯æç¤º
ğŸ”— [vite-plugin-dev-link] åŒ… "@test/ui-components" çš„ entryFile ä¸å­˜åœ¨: path/to/file (localPath: path/to/local)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡**: å¿…é¡»è®¾ç½® `DEV_LINK=true` ç¯å¢ƒå˜é‡æ‰èƒ½å¯ç”¨æ’ä»¶åŠŸèƒ½
2. **è·¯å¾„è§£æ**: ç›¸å¯¹è·¯å¾„ç›¸å¯¹äºé…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•è§£æï¼Œä¸æ˜¯å·¥ä½œç›®å½•
3. **æ–‡ä»¶æ‰©å±•å**: æ’ä»¶ä¼šè‡ªåŠ¨å°è¯• `.ts`, `.tsx`, `.js`, `.jsx`, `.vue` ç­‰æ‰©å±•å
4. **ä½œç”¨åŸŸåŒ…**: å®Œå…¨æ”¯æŒ `@scope/package-name` æ ¼å¼çš„ä½œç”¨åŸŸåŒ…
5. **æ€§èƒ½ä¼˜åŒ–**: åªåœ¨å¼€å‘æ¨¡å¼ä¸‹å¯ç”¨ï¼Œä¸å½±å“ç”Ÿäº§æ„å»º
6. **çƒ­æ›´æ–°**: ä¿®æ”¹æœ¬åœ°æ–‡ä»¶æ—¶ä¼šè‡ªåŠ¨è§¦å‘ HMR æ›´æ–°ï¼Œä¿æŒé¡µé¢çŠ¶æ€
7. **å®‰å…¨æ€§**: ä¸è®¾ç½®ç¯å¢ƒå˜é‡æ—¶æ’ä»¶å®Œå…¨ä¸å¯ç”¨

## ğŸ› ï¸ å¼€å‘

```bash
# å®‰è£…ä¾èµ–
npm install

# æ„å»ºæ’ä»¶
npm run build

# å¼€å‘æ’ä»¶ï¼ˆç›‘å¬æ–‡ä»¶å˜åŒ–ï¼‰
npm run dev:plugin

# è¿è¡Œæµ‹è¯•
npm test

# å¯åŠ¨ç¤ºä¾‹é¡¹ç›®
cd example
DEV_LINK=true npm run dev
```

## ğŸ“„ è®¸å¯è¯

MIT

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

> ğŸ”¥ è®©æœ¬åœ°åŒ…å¼€å‘å¦‚ä¸èˆ¬é¡ºæ»‘ï¼å†ä¹Ÿä¸ç”¨ä¸ºå¤æ‚çš„åŒ…é“¾æ¥å’Œçƒ­æ›´æ–°è€Œçƒ¦æ¼ã€‚
